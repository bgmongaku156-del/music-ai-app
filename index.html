<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI音楽生成</title>

<style>
body{
background:#000;
color:white;
text-align:center;
font-family:sans-serif;
padding:20px;
}

textarea{
width:90%;
height:120px;
font-size:16px;
}

button{
width:90%;
padding:20px;
margin:10px;
font-size:18px;
background:#2e7d32;
color:white;
border:none;
border-radius:10px;
}

button:disabled{
background:#555;
}

audio{
width:90%;
margin-top:20px;
}

#error{
width:90%;
margin:auto;
margin-top:20px;
background:#111;
padding:10px;
text-align:left;
font-size:13px;
white-space:pre-wrap;
}
</style>

</head>

<body>

<h1>AI音楽生成</h1>

<textarea id="prompt">relaxing ambient music</textarea>

<br>

<button onclick="generateMusic(10)" id="btn10">
10秒生成（テスト）
</button>

<button onclick="generateMusic(60)" id="btn60">
1分生成
</button>

<button onclick="generateMusic(180)" id="btn180">
3分生成
</button>

<p id="status">
待機中
</p>

<audio id="audio" controls></audio>

<div id="error"></div>

<script>

let generating=false;

async function generateMusic(sec){

if(generating)return;

generating=true;

status.innerText="生成中...";
error.innerText="";

btn10.disabled=true;
btn60.disabled=true;
btn180.disabled=true;

try{

let urls=[];

// ★ 分割数計算（30秒単位）
let parts=Math.ceil(sec/30);

for(let i=0;i<parts;i++){

status.innerText="生成中 "+(i+1)+" / "+parts;

// API呼び出し
const res=await fetch("/api/music",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

prompt:prompt.value,

duration:Math.min(30,sec)

})

});

const text=await res.text();

let data;

try{
data=JSON.parse(text);
}catch{
throw text;
}


// URL取得
let url=null;

if(data.audio_file){
url=data.audio_file.url;
}

else if(data.url){
url=data.url;
}

else if(data.audio){
url=data.audio.url;
}

else if(data.audios){
url=data.audios[0].url;
}

else if(data.data?.audio){
url=data.data.audio.url;
}

if(!url){
throw JSON.stringify(data,null,2);
}

urls.push(url);

}


// ★ 最初の曲を再生（安全版）
audio.src=urls[0];

audio.load();

audio.play();

status.innerText="生成完了";


}catch(e){

status.innerText="生成失敗";

error.innerText=e;

}

generating=false;

btn10.disabled=false;
btn60.disabled=false;
btn180.disabled=false;

}

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI音楽生成</title>

<style>
body{
background:#000;
color:white;
text-align:center;
font-family:sans-serif;
padding:20px;
}

textarea{
width:90%;
height:120px;
font-size:16px;
}

button{
width:90%;
padding:20px;
margin:10px;
font-size:18px;
background:#2e7d32;
color:white;
border:none;
border-radius:10px;
}

button:disabled{
background:#555;
}

audio{
width:90%;
margin-top:20px;
}

#error{
width:90%;
margin:auto;
margin-top:20px;
background:#111;
padding:10px;
text-align:left;
font-size:13px;
white-space:pre-wrap;
}
</style>

</head>

<body>

<h1>AI音楽生成</h1>

<textarea id="prompt">relaxing ambient music</textarea>

<br>

<button onclick="generateMusic(10)" id="btn10">
10秒生成（テスト）
</button>

<button onclick="generateMusic(60)" id="btn60">
1分生成
</button>

<button onclick="generateMusic(180)" id="btn180">
3分生成
</button>

<p id="status">
待機中
</p>

<audio id="audio" controls></audio>

<div id="error"></div>

<script>
let generating=false;

async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function generateMusic(sec){
  if(generating) return;

  generating=true;
  status.innerText="生成中...";
  error.innerText="";

  btn10.disabled=true;
  btn60.disabled=true;
  btn180.disabled=true;

  try{
    // 1) 生成を「投げる」(request_id を受け取る)
    const submitRes = await fetch("/api/music",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        prompt: prompt.value,
        duration: sec
      })
    });

    const submitText = await submitRes.text();
    let submitData;
    try{ submitData = JSON.parse(submitText); } catch { throw submitText; }

    if(!submitRes.ok || !submitData.request_id){
      throw JSON.stringify(submitData,null,2);
    }

    const requestId = submitData.request_id;

    // 2) 完了まで /api/status をポーリング（Vercel Timeoutしない）
    status.innerText="生成中（AI作曲中）...";
    let url = null;

    for(let i=0;i<120;i++){ // 最大 ~4分（2秒×120）
      await sleep(2000);

      const stRes = await fetch("/api/status?request_id="+encodeURIComponent(requestId));
      const stText = await stRes.text();
      let st;
      try{ st = JSON.parse(stText); } catch { throw stText; }

      if(st.status === "COMPLETED" && st.url){
        url = st.url;
        break;
      }

      // 任意：状態表示
      if(st.status){
        status.innerText = "生成中（"+st.status+"）...";
      }
    }

    if(!url){
      throw "時間内に完了しませんでした（混雑中の可能性）。もう一度試してください。";
    }

    // 3) 再生
    audio.src = url;
    audio.load();
    await audio.play().catch(()=>{});
    status.innerText="生成完了";
  }catch(e){
    status.innerText="生成失敗";
    error.innerText = String(e);
  }

  generating=false;
  btn10.disabled=false;
  btn60.disabled=false;
  btn180.disabled=false;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html>

<head>

<meta name="viewport" content="width=device-width">

<script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9468732939524959"
crossorigin="anonymous">
</script>

</head>


<body style="background:black;color:white;padding:20px;font-family:sans-serif;">


<h2>AI音楽生成</h2>


<textarea id="prompt"
style="width:100%;height:120px;">
relaxing ambient music
</textarea>


<p id="status">

広告を見てください

</p>



<!-- 広告 -->

<ins class="adsbygoogle"
style="display:block;height:100px"
data-ad-client="ca-pub-9468732939524959"
data-ad-slot="1234567890"
data-ad-format="auto">
</ins>

<script>
(adsbygoogle=window.adsbygoogle||[]).push({});
</script>


<br>


<button id="adBtn"
onclick="watchAd()"
style="width:100%;padding:20px;font-size:20px;">
広告を見る
</button>



<button id="btn1"
onclick="gen1min()"
disabled
style="width:100%;padding:20px;font-size:20px;">
1分生成（広告2回）
</button>



<button id="btn3"
onclick="gen3min()"
disabled
style="width:100%;padding:20px;font-size:20px;">
3分生成（広告3回）
</button>



<audio id="audio"
controls
style="width:100%;margin-top:20px;">
</audio>



<br><br>


<button id="downloadBtn"
onclick="watchDownloadAd()"
disabled
style="width:100%;padding:20px;font-size:20px;">
ダウンロード（広告1回）
</button>



<script>


let adsWatched=0
let generating=false
let downloadReady=false
let finalBlob=null



// 広告ブロック検出

function checkAdBlock(){

let ad=document.querySelector(".adsbygoogle")

if(!ad){

status.innerText="広告ブロッカーをOFFにしてください"

return false

}

if(ad.offsetHeight<50){

status.innerText="広告ブロッカーをOFFにしてください"

return false

}

return true

}




function watchAd(){

if(!checkAdBlock())return


adBtn.disabled=true


status.innerText=
"広告表示中 "+(adsWatched+1)+"回目"



setTimeout(()=>{


adsWatched++


status.innerText=
"広告 "+adsWatched+"回 視聴済み"



if(adsWatched>=2){

btn1.disabled=false

}


if(adsWatched>=3){

btn3.disabled=false

}


adBtn.disabled=false


},8000)


}





async function generate(seconds,count){

if(generating)return

if(!checkAdBlock())return


generating=true


btn1.disabled=true
btn3.disabled=true
adBtn.disabled=true


status.innerText="生成中..."


let blobs=[]


for(let i=0;i<count;i++){

let r=await fetch("/api/music",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

prompt:prompt.value,

duration:seconds

})

})


blobs.push(await r.blob())

}



let final=new Blob(blobs,{type:"audio/mpeg"})


audio.src=URL.createObjectURL(final)


finalBlob=final


status.innerText="生成完了"



adsWatched=0


downloadReady=true


downloadBtn.disabled=false


adBtn.disabled=false


generating=false


}




function gen1min(){

generate(30,2)

}



function gen3min(){

generate(90,2)

}




// ダウンロード広告


function watchDownloadAd(){

if(!downloadReady)return

if(!checkAdBlock())return


status.innerText="ダウンロード広告表示中..."


downloadBtn.disabled=true


setTimeout(()=>{


downloadFile()


},8000)


}




function downloadFile(){

let a=document.createElement("a")

a.href=URL.createObjectURL(finalBlob)

a.download="music.mp3"

a.click()


status.innerText="ダウンロード完了"


downloadReady=false


}



</script>


</body>

</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI音楽生成</title>

<style>
body{
background:#000;
color:white;
text-align:center;
font-family:sans-serif;
padding:20px;
}

textarea{
width:90%;
height:120px;
font-size:16px;
}

button{
width:90%;
padding:20px;
margin:10px;
font-size:18px;
background:#2e7d32;
color:white;
border:none;
border-radius:10px;
}

button:disabled{
background:#555;
}

audio{
width:90%;
margin-top:20px;
}

#error{
width:90%;
margin:auto;
margin-top:20px;
background:#111;
padding:10px;
text-align:left;
font-size:13px;
white-space:pre-wrap;
}
</style>

</head>

<body>

<h1>AI音楽生成</h1>

<textarea id="prompt">relaxing ambient music</textarea>

<br>

<button onclick="generateMusic(10)" id="btn10">
10秒生成（テスト）
</button>

<button onclick="generateMusic(60)" id="btn60">
1分生成
</button>

<button onclick="generateMusic(180)" id="btn180">
3分生成
</button>

<p id="status">
待機中
</p>

<audio id="audio" controls></audio>

<div id="error"></div>

<script>

const apiUrl="/api/music";

let generating=false;
let pollTimer=null;



function setButtonsDisabled(disabled){

document.getElementById("btn10").disabled=disabled;
document.getElementById("btn60").disabled=disabled;
document.getElementById("btn180").disabled=disabled;

}



function clearPoll(){

if(pollTimer) clearTimeout(pollTimer);

pollTimer=null;

}



async function safeJson(res){

const text=await res.text();

try{
return JSON.parse(text);
}
catch{

throw new Error(text);

}

}




async function generateMusic(sec){

if(generating) return;


generating=true;

clearPoll();


document.getElementById("status").innerText="生成中...";

document.getElementById("error").innerText="";

setButtonsDisabled(true);



try{

// 安定prompt取得
const promptText=
document.getElementById("prompt").value;


if(!promptText){

throw new Error("promptが空です");

}



// =====生成開始=====

const startRes=await fetch(apiUrl,{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

prompt:promptText,

duration:sec

})

});


const startJson=await safeJson(startRes);



if(!startRes.ok){

throw new Error(JSON.stringify(startJson,null,2));

}



if(!startJson.request_id){

throw new Error(JSON.stringify(startJson,null,2));

}


const requestId=startJson.request_id;


document.getElementById("status").innerText="作曲中...";



const startedAt=Date.now();

// 最大2分
const TIMEOUT=600000;




async function poll(){


// タイムアウト防止

if(Date.now()-startedAt>TIMEOUT){

throw new Error("時間内に完了しませんでした");

}


// ステータス取得

const stRes=await fetch(apiUrl,{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({

action:"status",

request_id:requestId

})

});


const stJson=await safeJson(stRes);



if(!stRes.ok){

throw new Error(JSON.stringify(stJson,null,2));

}



// 完了

if(stJson.status==="COMPLETED" && stJson.url){

const audio=document.getElementById("audio");


audio.src=stJson.url;

audio.load();

audio.play();


document.getElementById("status").innerText="生成完了";


generating=false;

setButtonsDisabled(false);


return;

}



// 進行表示

if(stJson.queue_position!=null){

document.getElementById("status").innerText=
"作曲中...（待ち順:"+stJson.queue_position+"）";

}else{

document.getElementById("status").innerText="作曲中...";

}



// 次回ポーリング

pollTimer=setTimeout(()=>poll().catch(onFail),3000);


}




function onFail(e){

clearPoll();

document.getElementById("status").innerText="生成失敗";

document.getElementById("error").innerText=
(e && e.message)?e.message:String(e);

generating=false;

setButtonsDisabled(false);

}



// 開始

poll().catch(onFail);



}catch(e){

clearPoll();

document.getElementById("status").innerText="生成失敗";

document.getElementById("error").innerText=
(e && e.message)?e.message:String(e);

generating=false;

setButtonsDisabled(false);

}


}



</script>

</body>
</html>

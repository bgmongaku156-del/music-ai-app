<script>
let generating=false;

async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function saveLastRequest(id){
  try{ localStorage.setItem("last_request_id", id); }catch(e){}
}
function loadLastRequest(){
  try{ return localStorage.getItem("last_request_id"); }catch(e){ return null; }
}
function clearLastRequest(){
  try{ localStorage.removeItem("last_request_id"); }catch(e){}
}

async function pollUntilDone(requestId){
  // 15分（2.5秒×360回）
  const maxTries = 360;
  const intervalMs = 2500;

  for(let i=0;i<maxTries;i++){
    await sleep(intervalMs);

    const stRes = await fetch("/api/status?request_id="+encodeURIComponent(requestId), { cache:"no-store" });
    const stText = await stRes.text();
    let st;
    try{ st = JSON.parse(stText); }catch{ throw stText; }

    if(st.status === "COMPLETED" && st.url){
      return st.url;
    }

    if(st.status){
      status.innerText = "生成中（"+st.status+"）... " + Math.round(((i+1)/maxTries)*100) + "%";
    }else{
      status.innerText = "生成中... " + Math.round(((i+1)/maxTries)*100) + "%";
    }
  }

  // ここまで来ても終わらない＝混雑。失敗扱いではなく「あとで再取得できる」メッセージにする
  throw "まだ生成中です（混雑）。少し時間をおいて、もう一度同じボタンを押してください。";
}

async function generateMusic(sec){
  if(generating) return;

  generating=true;
  status.innerText="生成中...";
  error.innerText="";

  btn10.disabled=true;
  btn60.disabled=true;
  btn180.disabled=true;

  try{
    // ① まず「前回のrequest」が残ってたら先に回収を試す（連打や混雑でも無駄にならない）
    const last = loadLastRequest();
    if(last){
      status.innerText="前回の生成を確認中...";
      try{
        const url = await pollUntilDone(last);
        audio.src = url;
        audio.load();
        await audio.play().catch(()=>{});
        status.innerText="生成完了（前回の続き）";
        clearLastRequest();
        return;
      }catch(e){
        // まだ終わってない/別の問題なら、このまま新規生成に進む
        // ※混雑で長い場合はここで止めたいなら return してOK
      }
    }

    // ② 新規生成を「投げる」（request_idを保存）
    const submitRes = await fetch("/api/music",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ prompt: prompt.value, duration: sec })
    });

    const submitText = await submitRes.text();
    let submitData;
    try{ submitData = JSON.parse(submitText); } catch { throw submitText; }

    if(!submitRes.ok || !submitData.request_id){
      throw JSON.stringify(submitData,null,2);
    }

    const requestId = submitData.request_id;
    saveLastRequest(requestId);

    // ③ 完了までポーリング
    status.innerText="生成中（AI作曲中）...";
    const url = await pollUntilDone(requestId);

    // ④ 再生
    audio.src = url;
    audio.load();
    await audio.play().catch(()=>{});
    status.innerText="生成完了";
    clearLastRequest();

  }catch(e){
    status.innerText="生成失敗";
    error.innerText = String(e);
    // request_id は残しておく（後で回収できるように）
  }

  generating=false;
  btn10.disabled=false;
  btn60.disabled=false;
  btn180.disabled=false;
}
</script>

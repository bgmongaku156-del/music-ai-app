<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI音楽生成</title>
  <style>
    body{background:#111;color:#fff;font-family:sans-serif;text-align:center;padding:20px}
    textarea{width:90%;height:110px;font-size:16px}
    button{width:90%;padding:16px;font-size:18px;margin-top:10px;border:0;border-radius:10px;background:green;color:#fff}
    button:disabled{background:#444}
    audio{width:90%;margin-top:16px}
    pre{white-space:pre-wrap;text-align:left;background:#222;padding:12px;border-radius:10px;width:90%;margin:16px auto 0}
  </style>
</head>
<body>
  <h2>AI音楽生成</h2>

  <textarea id="prompt">relaxing ambient music</textarea>

  <button id="gen10" onclick="gen(10)">10秒生成（テスト）</button>
  <button id="gen30" onclick="gen(30)">30秒生成（テスト）</button>

  <div id="status" style="margin-top:12px">待機中</div>
  <audio id="player" controls></audio>
  <pre id="debug"></pre>

  <script>
    let running = false;

    async function gen(sec){
      if(running) return;
      running = true;

      document.getElementById("gen10").disabled = true;
      document.getElementById("gen30").disabled = true;

      status.textContent = "生成中...";
      debug.textContent = "";

      try{
        const res = await fetch("/api/music",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ prompt: prompt.value, duration: sec })
        });

        const data = await res.json().catch(()=>({error:"invalid json"}));

        if(!res.ok || !data.url){
          status.textContent = "生成失敗";
          debug.textContent = JSON.stringify({ httpStatus: res.status, data }, null, 2);
          throw new Error("failed");
        }

        player.src = data.url;
        status.textContent = `生成完了（${data.model || "unknown"}）`;
        debug.textContent = JSON.stringify(data, null, 2);

      }catch(e){
        if(!debug.textContent) debug.textContent = String(e);
      }

      document.getElementById("gen10").disabled = false;
      document.getElementById("gen30").disabled = false;
      running = false;
    }
  </script>
</body>
</html>

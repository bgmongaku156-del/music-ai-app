<!DOCTYPE html>
<html>

<body style="background:black;color:white;padding:20px;font-family:sans-serif;">

<h2>AI音楽生成</h2>

<textarea id="prompt"
style="width:100%;height:120px;">
relaxing ambient music
</textarea>


<button id="btn1"
onclick="make1min()"
style="width:100%;padding:20px;font-size:20px;">
1分生成（広告3回）
</button>


<button id="btn2"
onclick="make3min()"
style="width:100%;padding:20px;font-size:20px;">
3分生成（広告4回）
</button>


<div id="status"
style="margin-top:20px;font-size:20px;">
待機中
</div>


<audio id="player"
controls
style="width:100%;margin-top:20px;">
</audio>


<script>

let generating=false


function lockButtons(){

document.getElementById("btn1").disabled=true
document.getElementById("btn2").disabled=true

}


function unlockButtons(){

document.getElementById("btn1").disabled=false
document.getElementById("btn2").disabled=false

}



async function generate(prompt,seconds){

const r=await fetch("/api/music",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({
prompt:prompt,
seconds:seconds
})

})

return await r.json()

}



// 簡易広告

async function showAds(times){

for(let i=0;i<times;i++){

alert("広告を見てください ("+(i+1)+"/"+times+")")

}

}



// 共通生成

async function generateParts(prompt,seconds,parts,ads){

if(generating)return

generating=true

lockButtons()

await showAds(ads)

document.getElementById("status").innerText="生成中..."

let list=[]

for(let i=0;i<parts;i++){

let d=await generate(prompt,seconds)

list.push(d.url)

}

document.getElementById("status").innerText="生成完了"

playList(list)

unlockButtons()

generating=false

}



// 1分生成

function make1min(){

const prompt=
document.getElementById("prompt").value

generateParts(prompt,30,2,3)

}



// 3分生成

function make3min(){

const prompt=
document.getElementById("prompt").value

generateParts(prompt,90,2,4)

}



// 再生

function playList(list){

let i=0

player.src=list[0]

player.onended=function(){

i++

if(i<list.length){

player.src=list[i]

player.play()

}

}

player.play()

}

</script>

</body>

</html>

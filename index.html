export default async function handler(req, res) {

const FAL_KEY=process.env.FAL_KEY;

if(!FAL_KEY){

return res.status(500).json({
error:"FAL_KEY missing"
});

}



// ===== GET（状態確認）

if(req.method==="GET"){

const requestId=req.query.request_id;

if(!requestId){

return res.status(400).json({
error:"request_id required"
});

}

try{


const statusRes=await fetch(

`https://queue.fal.run/fal-ai/stable-audio-25/text-to-audio/requests/${requestId}/status`,

{
headers:{
Authorization:`Key ${FAL_KEY}`
}
}
);


const status=await statusRes.json();



if(status.status!=="COMPLETED"){

return res.json({
status:status.status
});

}



// 完了したら取得


const resultRes=await fetch(

`https://queue.fal.run/fal-ai/stable-audio-25/text-to-audio/requests/${requestId}`,

{
headers:{
Authorization:`Key ${FAL_KEY}`
}
}
);


const result=await resultRes.json();



const url=

result?.audio?.url ||

result?.audio_file?.url ||

null;



return res.json({

status:"COMPLETED",

url:url

});


}catch(e){

return res.status(500).json({
error:String(e)
});

}

}




// ===== POST（生成開始）

if(req.method==="POST"){

try{


const body=req.body;

const prompt=body.prompt||"music";

const duration=body.duration||10;



const falRes=await fetch(

"https://queue.fal.run/fal-ai/stable-audio-25/text-to-audio",

{
method:"POST",

headers:{
"Content-Type":"application/json",
Authorization:`Key ${FAL_KEY}`
},

body:JSON.stringify({

prompt:prompt,

seconds_total:duration,

num_inference_steps:4,
guidance_scale:1

})

}
);


const falJson=await falRes.json();


return res.json({

request_id:falJson.request_id

});


}catch(e){

return res.status(500).json({
error:String(e)
});

}

}



// ===== その他


return res.status(200).json({
error:"Use POST or GET"
});


}
